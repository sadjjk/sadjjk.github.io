<html>
<head>
  <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<title>美团美食参数加密-解析餐厅列表 | 金鱼的今语</title>
<link rel="shortcut icon" href="https://sadjjk.github.io/favicon.ico?v=1668343231821">
<link rel="stylesheet" href="https://sadjjk.github.io/styles/main.css" type='text/css' media='all'>
<link href="https://sadjjk.github.io/media/scripts/autoc.css" rel="stylesheet">

<script src="https://sadjjk.github.io/media/scripts/lib/highlight.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/moment.min.js"></script>
<link href="https://sadjjk.github.io/media/scripts/katex.min.css" rel="stylesheet">



</head>
<body class="home blog ct-body standard">
<div id="overflow-container" class="overflow-container">
  <header id="site-header" class="site-header" role="banner">


    <div class="container">
        <div id="title-info" class="title-info">
            <div id='site-title' class='site-title'>
                <a href="https://sadjjk.github.io">  金鱼的今语 </a>
            </div>
        </div>
        <button id="toggle-navigation" class="toggle-navigation">
            <i class="fa fa-bars"></i>
        </button>
        <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
        <div id="menu-primary" class="menu-container menu-primary" role="navigation">
            <p class="site-description">真话、假话、胡话、全都说</p>
            <div class="menu">
                <ul id="menu-primary-items" class="menu-primary-items">
                     
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/">首页</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/archives">归档</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/tags">标签</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://bili.wjinyu.top" target="_blank">B站视频解析</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://video.wjinyu.top" target="_blank">今日追剧</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="http://music.wjinyu.top" target="_blank">今语云音乐</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/post/about">关于</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>


</header>


  <div id="main" class="main" role="main">
    <div id="loop-container" class="loop-container">
      <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">
        
          <div class='featured-image lazy lazy-bg-image' data-background="http://img.mp.itc.cn/upload/20170327/81d1fad5df4249218dbc6abfb90ee833_th.jpg">
          </div>
        

        <div class="entry-meta">
          <span class="date">· 2022-06-26 ·</span>

          
            <span class="category">
                    <span> / </span>
                    <a href="https://sadjjk.github.io/tag/pa-chong/">爬虫</a>
                </span>
          
        </div>
        <div class='entry-header'>
          <h1 class='entry-title'>美团美食参数加密-解析餐厅列表</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article id="article">

            </article>
          </div>
        </div>
          
            <nav class="navigation pagination" role="navigation">
              <h2 class="screen-reader-text">Posts navigation</h2>
              <div class="nav-links">
                <a class="next page-numbers" style="font-size:20px" href="https://sadjjk.github.io/post/wang-yi-yun-yin-le-js-jia-mi-wu-nao-kou/">下一篇->网抑云音乐AES加密-解析音乐地址</a>
              </div>
            </nav>
          
      </div>
      <section id="comments" class="comments">
        
      </section>
    </div>
  </div>
  <footer id="site-footer" class="site-footer" role="contentinfo">
    <h1>
        <a href="https://sadjjk.github.io"> 金鱼的今语 </a>
    </h1>
    <p class="site-description" style="font-size:18px">真话、假话、胡话、全都说</p>
    <div id="menu-footer" class="menu-container menu-footer" role="navigation">
        <div class="menu">
            <ul id="menu-footer-items" class="menu-footer-items">
            </ul>
        </div>
    </div>
    <ul class="social-media-icons">
        
            
                <li>
                    <a href="https://github.com/sadjjk" data-animate-hover="pulse" class="github" target="_blank">
                        <i class="fab fa-github" title="github"></i>
                        <span class="screen-reader-text">github</span>
                    </a>
                </li>
            
        
            
        
            
                <li>
                    <a href="https://weibo.com/ " data-animate-hover="pulse" class="weibo" target="_blank">
                        <i class="fab fa-weibo" title="weibo"></i>
                        <span class="screen-reader-text">weibo</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.zhihu.com/" data-animate-hover="pulse" class="zhihu" target="_blank">
                        <i class="fab fa-zhihu" title="zhihu"></i>
                        <span class="screen-reader-text">zhihu</span>
                    </a>
                </li>
            
        
            
        
            
        
            
        
            
        
    </ul>
    <div class="design-credit">
        <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="/atom.xml" target="_blank">RSS</a> | <a href="https://beian.miit.gov.cn" target="_blank">&nbsp;浙ICP备2021037254号-1</a> | <img src="/post-images/gongan.png">浙公网安备 33108202000706号</p>
    </div>
</footer>

<script>
hljs.initHighlightingOnLoad()
</script>
<script src="https://sadjjk.github.io/media/scripts/lib/autoc.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/jquery.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/production.min.js"></script>

  <script>
    var article = `<p>唯美食不可辜负</p>
<!--more-->
<h4 id="爬取目标">爬取目标</h4>
<p>根据美团美食爬取对应推荐餐厅列表</p>
<ul>
<li>
<p>输入</p>
<p>网址:https://(城市缩写).meituan.com/meishi/</p>
<p>如:https://hz.meituan.com/meishi/</p>
<p>这里的城市缩写由美团定义 后续代码中已申明各城市对应的缩写</p>
</li>
<li>
<p>输出</p>
</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lnnx0199j20w10u077s.jpg" alt="" loading="lazy"></figure>
<h4 id="目标分析">目标分析</h4>
<p>该页面需要强制登陆后才可登陆</p>
<p>因此一定是需要Cookies验证</p>
<p>目标接口:https://hz.meituan.com/meishi/api/poi/getPoiList</p>
<p>GET请求 请求参数</p>
<p>其中<code>user</code>为当前登陆用户id</p>
<p><code>uuid</code>为唯一标识 可从Cookies中获取</p>
<p><code>_token</code>为加密结果</p>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lnsa5b65j22f80akte8.jpg" alt="" loading="lazy"></figure>
<p>经过一番探索和查询</p>
<p>加密方式为请求参数转二级制再进base64加密 再重复一遍 得到最终加密结果</p>
<h4 id="爬取过程">爬取过程</h4>
<p>这里原本想使用无脑扣JS的方法 扣到转二进制时最后发现难以进行下去 故查询相关资料</p>
<p>发现Python复现更加优雅简洁 因此主要用Python实现加密过程</p>
<h5 id="1搜索请求参数关键词">1.搜索请求参数关键词</h5>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lo2q57h4j22uc0psdrv.jpg" alt="" loading="lazy"></figure>
<p>搜索请求参数关键词<code>_token</code>  左侧出现所有与该关键词有关的js文件 挨个查看</p>
<p>发现<code>index.js</code>文件中出现<code>_token</code>定义  打点调试进入该段函数</p>
<h5 id="2分析加密过程">2.分析加密过程</h5>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lofbr9aij21980o0tfw.jpg" alt="" loading="lazy"></figure>
<p>输入<code>jv</code>  中间变量<code>jx</code> 、<code>iP</code> 输出<code>jw</code>(即最终加密结果) 查询各个变量值</p>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lp775b9gj21s20gutbs.jpg" alt="" loading="lazy"></figure>
<p><code>iP</code> 字典 基本为常量</p>
<figure data-type="image" tabindex="6"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lpm5gqqmj216o0f8mzb.jpg" alt="" loading="lazy"></figure>
<p><code>jv</code>即不含<code>_token</code>的其他参数</p>
<p><code>jx</code>即将各个参数解析成字典 再通过<code>iJ</code>函数生成sign值 赋值给<code>iP</code></p>
<pre><code class="language-javascript">iP.sign = iJ(jx);
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lph1f2swj20oi07o0uc.jpg" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="8"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3lpibj3sdj22em02a75f.jpg" alt="" loading="lazy"></figure>
<p><code>jd</code> 即<code>jx</code>字典按key排序后 再&amp;拼接</p>
<p>最后通过<code>iI</code>函数返回最终的sign值</p>
<pre><code class="language-javascript">var iI = function(jc) {
                    jc = cD.deflate(JSON.stringify(jc));
                    jc = iD(jc);
                    return jc
                };
</code></pre>
<p>其中<code>cD.deflate</code>这段的js比较难扣 难以复现 可以先跳过这段加密逻辑</p>
<p>最终将生成的sign值 赋值给<code>iP</code></p>
<p>再对<code>iP</code>字典进行一次<code>iI</code>函数加密 加密后的结果为最终的<code>_token</code></p>
<h5 id="3python复现核心加密逻辑">3.Python复现核心加密逻辑</h5>
<p><code>iI</code>函数 用Python的复现逻辑如下</p>
<pre><code>def decode_sign(token_string):
    # base编码
    encode1 = str(token_string).encode()
    # 参数 压缩成 特殊的编码 -&gt;
    compress = zlib.compress(encode1)  # 二进制压缩
    b_encode = base64.b64encode(compress)
    # 转变 str
    e_sign = str(b_encode, encoding='utf-8')
    return e_sign
</code></pre>
<h5 id="4最后封装-发起请求">4.最后封装 发起请求</h5>
<h4 id="爬虫源码">爬虫源码</h4>
<p><a href="https://github.com/sadjjk/PythonSpiderDemo/blob/master/%E7%BE%8E%E5%9B%A2%E7%BE%8E%E9%A3%9F/meituan.py">Github</a></p>
<h4 id="总结">总结</h4>
<p>美团美食的核心加密逻辑的js比较复杂 难以扣出来复现</p>
<p>在实际探索过程中 发现<code>iI</code>函数变成了二进制</p>
<p>但没有相关的经验 就很难反应出是二进制压缩</p>
<p>因此 <strong>熟能生巧</strong></p>
`
    var content = article.split("<!--more-->")[1]
    if (content != null)
        document.getElementById('article').innerHTML = content;
    else
        document.getElementById('article').innerHTML = article

    let navigation = new AutocJs({
        title:'美团美食参数加密-解析餐厅列表',
        isGenerateOutlineChapterCode: false
    })
    </script>
</div>
</body>
</html>

