<html>
<head>
  <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<title>macOS破解Chrome保存的密码————他失败 失败了 | 金鱼的今语</title>
<link rel="shortcut icon" href="https://sadjjk.github.io/favicon.ico?v=1668343231821">
<link rel="stylesheet" href="https://sadjjk.github.io/styles/main.css" type='text/css' media='all'>
<link href="https://sadjjk.github.io/media/scripts/autoc.css" rel="stylesheet">

<script src="https://sadjjk.github.io/media/scripts/lib/highlight.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/moment.min.js"></script>
<link href="https://sadjjk.github.io/media/scripts/katex.min.css" rel="stylesheet">



</head>
<body class="home blog ct-body standard">
<div id="overflow-container" class="overflow-container">
  <header id="site-header" class="site-header" role="banner">


    <div class="container">
        <div id="title-info" class="title-info">
            <div id='site-title' class='site-title'>
                <a href="https://sadjjk.github.io">  金鱼的今语 </a>
            </div>
        </div>
        <button id="toggle-navigation" class="toggle-navigation">
            <i class="fa fa-bars"></i>
        </button>
        <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
        <div id="menu-primary" class="menu-container menu-primary" role="navigation">
            <p class="site-description">真话、假话、胡话、全都说</p>
            <div class="menu">
                <ul id="menu-primary-items" class="menu-primary-items">
                     
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/">首页</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/archives">归档</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/tags">标签</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://bili.wjinyu.top" target="_blank">B站视频解析</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://video.wjinyu.top" target="_blank">今日追剧</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="http://music.wjinyu.top" target="_blank">今语云音乐</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/post/about">关于</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>


</header>


  <div id="main" class="main" role="main">
    <div id="loop-container" class="loop-container">
      <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">
        
          <div class='featured-image lazy lazy-bg-image' data-background="https://i.loli.net/2019/11/30/BvIhxj582M1Oz9A.jpg">
          </div>
        

        <div class="entry-meta">
          <span class="date">· 2019-11-30 ·</span>

          
            <span class="category">
                    <span> / </span>
                    <a href="https://sadjjk.github.io/tag/work/">Work</a>
                </span>
          
        </div>
        <div class='entry-header'>
          <h1 class='entry-title'>macOS破解Chrome保存的密码————他失败 失败了</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article id="article">

            </article>
          </div>
        </div>
          
            <nav class="navigation pagination" role="navigation">
              <h2 class="screen-reader-text">Posts navigation</h2>
              <div class="nav-links">
                <a class="next page-numbers" style="font-size:20px" href="https://sadjjk.github.io/post/BilibiliVideo_last/">下一篇->BilibiliVideo-后话篇</a>
              </div>
            </nav>
          
      </div>
      <section id="comments" class="comments">
        
      </section>
    </div>
  </div>
  <footer id="site-footer" class="site-footer" role="contentinfo">
    <h1>
        <a href="https://sadjjk.github.io"> 金鱼的今语 </a>
    </h1>
    <p class="site-description" style="font-size:18px">真话、假话、胡话、全都说</p>
    <div id="menu-footer" class="menu-container menu-footer" role="navigation">
        <div class="menu">
            <ul id="menu-footer-items" class="menu-footer-items">
            </ul>
        </div>
    </div>
    <ul class="social-media-icons">
        
            
                <li>
                    <a href="https://github.com/sadjjk" data-animate-hover="pulse" class="github" target="_blank">
                        <i class="fab fa-github" title="github"></i>
                        <span class="screen-reader-text">github</span>
                    </a>
                </li>
            
        
            
        
            
                <li>
                    <a href="https://weibo.com/ " data-animate-hover="pulse" class="weibo" target="_blank">
                        <i class="fab fa-weibo" title="weibo"></i>
                        <span class="screen-reader-text">weibo</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.zhihu.com/" data-animate-hover="pulse" class="zhihu" target="_blank">
                        <i class="fab fa-zhihu" title="zhihu"></i>
                        <span class="screen-reader-text">zhihu</span>
                    </a>
                </li>
            
        
            
        
            
        
            
        
            
        
    </ul>
    <div class="design-credit">
        <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="/atom.xml" target="_blank">RSS</a> | <a href="https://beian.miit.gov.cn" target="_blank">&nbsp;浙ICP备2021037254号-1</a> | <img src="/post-images/gongan.png">浙公网安备 33108202000706号</p>
    </div>
</footer>

<script>
hljs.initHighlightingOnLoad()
</script>
<script src="https://sadjjk.github.io/media/scripts/lib/autoc.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/jquery.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/production.min.js"></script>

  <script>
    var article = `<p>毫无疑问失败了 无功而返<br>
但是探索的过程非常有意思<br>
值得记录下</p>
<!--more-->
<h3 id="起源">起源</h3>
<p>这事要从这篇文章<a href="https://mp.weixin.qq.com/s/DbsEc4YVQ0442ibfJMYO7w">使用python假装装黑客，批量破解朋友的网站密码</a>开始说起<br>
这篇文章介绍了如何在Win下破解Chrome浏览器存储的密码<br>
简单的说<br>
Chrome保存的密码都记录在固定位置(<code>当前用户\Google\Chrome\User Data\Default\Login Data</code>)的文件中 而该文件恰恰是SQLite数据库文件 随便个SQLite工具均可打开</p>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2019/11/30/KsUe9dZEtyHGqTX.png" alt="UTOOLS_COMPRESS_1575114584023.png" loading="lazy"></figure>
<p>username_value 即账号<br>
password_value 即密码<br>
显然密码不是明文 是经过加密的<br>
Win下妙就妙在 python可是使用三方库<code>win32crypt</code>的<code>CryptUnprotectData</code>方法 即可解密查看明文<br>
然后一切就变得非(索)常(然)简(无)单(味)<br>
要是再加工打包成EXE 发布出去<br>
即可轻松获取对方的账号密码<br>
具体的代码细节 这里不再过多阐述<br>
既然Win下已成功破解 那么macOS系统呢<br>
好戏开始！</p>
<h3 id="探索">探索</h3>
<p>macOS系统中Python并没有像三方库<code>win32crypt</code>的<code>CryptUnprotectData</code>方法<br>
也就是没有轮子 需要从底层分析是如何加密   再解密<br>
了解到几篇文章</p>
<p><a href="https://www.freebuf.com/articles/web/117038.html">《手把手教你解密MacOS平台下的Chrome密码》</a></p>
<p><a href="https://www.jianshu.com/p/c94363c33bae">《Python实现获取macOS系统Chrome的Cookies数据》</a></p>
<p>Chrome的Cookies和login的password使用的是同一套方法<br>
都是保存在SQLite文件中 加密的方法应该都是一样的<br>
加密的方法来自<a href="https://github.com/chromium/chromium/blob/master/components/os_crypt/os_crypt_mac.mm">Github中Chrome的源码</a><br>
源码中使用的加密机制为：AES-128-CBC（使用固定盐值和固定迭代次数）</p>
<ol>
<li>
<p>盐值：盐值固定不变（saltysalt）；</p>
</li>
<li>
<p>迭代次数：在对称密钥的生成过程中进行1003次迭代计算；</p>
</li>
<li>
<p>IV：空字符串 16位；</p>
</li>
<li>
<p>哈希函数：sha1；</p>
</li>
<li>
<p>password：加密的密码</p>
</li>
</ol>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2019/11/30/SkDWBNMraYLjo83.png" alt="UTOOLS_COMPRESS_1575115968886.png" loading="lazy"></figure>
<h3 id="整理">整理</h3>
<h4 id="第一步">第一步</h4>
<p>首先获取加密的密码<br>
macOS中都记录在钥匙串keyChain中<br>
直接在macOS中iTerm输入<code>security  find-generic-password -ga 'Chrome'</code><br>
然后提示输入密码(需输入两遍 这是个系统小bug)<br>
即可出现<br>
<img src="https://i.loli.net/2019/11/30/9DW3cixsgXZJBz1.png" alt="UTOOLS_COMPRESS_1575116489356.png" loading="lazy"></p>
<p>最下方的password即是密码<br>
该密码是经过base64编码的 需要decode<br>
(在尝试的过程中 直到很后面才发现要解码 不可直接拿来使用)<br>
在更早期的macOS版本 连密码都不用输入<br>
参考的文章中当时(大概是2016年~2017年)就是不用输密码的<br>
<strong>no code no bb</strong><br>
这里Python有两种方法实现上述过程<br>
第一种：Python2使用commands;Python3使用subprocess<br>
都是自带的库  作用是调用执行命令<br>
传入命令 输入密码即可获得返回值<br>
这个是比较简单方便的</p>
<pre><code class="language-python">import subprocess
safeStorageKey = subprocess.getstatusoutput(&quot;security  find-generic-password -ga 'Chrome' | awk '{print $2}' 2&gt;&amp;1 &gt;/dev/null&quot;)[1]
safeStorageKey = safeStorageKey.split(&quot;:&quot;)[1].replace(&quot;\&quot;&quot;,&quot;&quot;)
safeStorageKey = base64.b64decode(safeStorageKey)
</code></pre>
<p>第二种：使用三方库keyring<br>
需要下载三方库 pip install keyring<br>
但keyring爆出过安全漏洞<br>
毕竟是和系统密码相关<br>
不推荐使用</p>
<pre><code class="language-python">import keyring
safeStorageKey = keyring.get_password('Chrome Safe Storage', 'Chrome')
safeStorageKey = base64.b64decode(safeStorageKey)
</code></pre>
<h4 id="第二步">第二步</h4>
<p>AES解密 得到明文<br>
同样有两种方法<br>
第一种<br>
python Crypto模块的安装<br>
这个三方库由于些历史原因<br>
安装方法有些小坑 什么小写改大写<br>
具体安装详情Google或度娘吧<br>
使用的参数就是上文提到过的盐值、哈希函数、迭代次数、IV值</p>
<pre><code class="language-python">import hashlib
from Crypto.Cipher import AES

# SQLite文件中加密的password_value字段的值 类型为字节
# 其中前三位为v10或v11 是写死的 需过滤掉
encrypted_value = b'v10\x0bY\xd27\x0bJ\x1c0\xd39#\xd2\n\x82{\x1f'

key = hashlib.pbkdf2_hmac('sha1', safeStorageKey, b'saltysalt', 1003)[:16]
cipher = AES.new(key, AES.MODE_CBC, IV=b' ' * 16)
decrypted_string = cipher.decrypt(encrypted_value[3:])
</code></pre>
<p>第二种<br>
使用系统自带的openssl解密<br>
不用安装额外的库<br>
同样是Python调用命令</p>
<pre><code class="language-python">import subprocess
import hashlib

encrypted_value = b'v10\x0bY\xd27\x0bJ\x1c0\xd39#\xd2\n\x82{\x1f'
iv = ''.join(('20',) * 16)  # 16个空字符串的16进制是16个20
key = hashlib.pbkdf2_hmac('sha1', safeStorageKey, b'saltysalt', 1003)[:16]
result = subprocess.getstatusoutput(&quot;openssl enc -d -aes-128-cbc -iv '%s' -K %s &lt; '%s' &quot; % (iv, key, encrypted_value[3:])&quot;)
</code></pre>
<h3 id="失败">失败</h3>
<p>按上面的步骤 一切好像非常流畅<br>
但在解密明文的最终结果上<br>
懵逼了<br>
按照第一种方法 得到的decrypted_string根本就不是明文密码<br>
按照第二种方法 openssl 直接卡死 没有返回结果</p>
<h3 id="复盘">复盘</h3>
<p><strong>在整个失败复盘过程中<br>
最可能出的问题 应该第一步</strong><br>
参考的文章中有出现过password<br>
使用它的password是可以解码回字符串的</p>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2019/11/30/k2rO3W1aLBpqnPo.png" alt="UTOOLS_COMPRESS_1575117043985.png" loading="lazy"></figure>
<p><img src="https://i.loli.net/2019/11/30/IL1z2cdmCVP5lQH.png" alt="UTOOLS_COMPRESS_1575117330016.png" loading="lazy">而现在再尝试已经无法再转码成utf8了<br>
<img src="https://i.loli.net/2019/11/30/2e65FGDkS7mB3Y1.png" alt="UTOOLS_COMPRESS_1575117234849.png" loading="lazy"></p>
<p>按照这个线索 再搜索keyChain的相关资料 找到了这篇关键材料</p>
<p><a href="https://bbs.pediy.com/thread-220981.htm">《实验code review 解码苹果上所有的Tokens decrypts/extracts all authorization tokens on macOS/OSX》</a></p>
<p>文章中作者提出破解iCoud的办法  且已经向苹果上报了bug<br>
文章中还出现了<strong>OSXChromeDecrypt</strong> 也就是《《手把手教你解密MacOS平台下的Chrome密码》的项目代码<br>
不亏是大神  原来都是出自他之手<br>
最重要的一段</p>
<blockquote>
<p>这个 <strong>DSID</strong> 格式文件使用了<strong>128位AES的CBC模式</strong>[^注1] 和一个空的<strong>初始化向量</strong>进行加密。针对这个文件的解密密钥存储在用户的<strong>钥匙串</strong>里，一个名为 <strong>iCloud</strong> 的服务条目下，名字是 iCloud 账户相关的邮件地址。</p>
<p><strong>这个解密钥匙进行了 base64 编码，并作为 Hmac 算法[^注2]中的消息体，进行标准的 MD5 哈希加密</strong>。<strong>这里的问题是，Hmac 算法里所需的输入钥匙，被藏在了 MacOS 内核深处</strong>。这个钥匙由44个随机字符组成，它是解密 DSID 文件的关键。<strong>这个钥匙包含在本工程的源代码中，据我所知，到目前为止这个钥匙还未被公开过</strong>。</p>
</blockquote>
<p>是不是很熟悉 AES CBC 空的IV 加密的秘钥<br>
等等<br>
&quot;这个解密钥匙进行了 base64 编码，并作为 Hmac 算法中的消息体，进行标准的 MD5 哈希加密&quot;<br>
原来还有一层MD5哈希加密<br>
(当时真的高兴坏了 如获至宝 )<br>
继续 no code no bb<br>
key = &quot;t9s&quot;lx^awe.580Gj%'ld+0LG&lt;#9xa?&gt;vb)-fkwb92[}&quot; 这串神秘数字</p>
<pre><code>
# 硬编码在系统中的字符串
#Constant key used for hashing Hmac on all versions of MacOS.
#this is the secret to the decryption!
#/System/Library/PrivateFrameworks/AOSKit.framework/Versions/A/AOSKit yields the following subroutine
#KeychainAccountStorage _generateKeyFromData:
#that uses the below key that calls CCHmac to generate a Hmac that serves as the decryption key
key = &quot;t9s\&quot;lx^awe.580Gj%'ld+0LG&lt;#9xa?&gt;vb)-fkwb92[}&quot;

# md5 算法作为 Hmac 中的哈希算法
hashed = hmac.new(key, safeStorageKey, digestmod=hashlib.md5).digest()
hexedKey = binascii.hexlify(hashed) 

# 然后再把hexedKey传入AES中
</code></pre>
<p>哎 还是失败了  还是没有解析出正确的明文<br>
莫非是神秘数字已经是修改了？<br>
文章中提到了神秘数字的来源<code>/System/Library/PrivateFrameworks/AOSKit.framework/Versions/A/AOSKit</code><br>
打开这个文件 都是乱码 应该是已经被编译的<br>
思路从这里开始彻底没了  ！<br>
真的放弃了</p>
<h3 id="总结">总结</h3>
<p>几乎的所有的参考文件及代码的时间点都在2018年以前<br>
Github中的也没有最新的issue<br>
尤其是最后找到的关键材料<br>
文章提到作者一直在联系苹果 希望修复钥匙串访问的bug<br>
按目前的情况来看  应该是已经是被fix了<br>
但Chrome那一层的加密算法应该还是原封不动<br>
所有的结果都对的上<br>
就是AES加密使用到的password 是怎么来的<br>
已经不得而知<br>
或许是修改了加密的算法 或许是修改了神秘数字<br>
最后不得不说 macOS的安全性实在是高！<br>
END</p>
<h3 id="参考">参考</h3>
<h4 id="文章">文章</h4>
<ul>
<li><a href="https://mp.weixin.qq.com/s/DbsEc4YVQ0442ibfJMYO7w">使用python假装装黑客，批量破解朋友的网站密码</a></li>
<li><a href="https://www.freebuf.com/articles/web/117038.html">《手把手教你解密MacOS平台下的Chrome密码》</a></li>
<li><a href="https://www.jianshu.com/p/c94363c33bae">《Python实现获取macOS系统Chrome的Cookies数据》</a></li>
<li><a href="https://bbs.pediy.com/thread-220981.htm">《实验code review 解码苹果上所有的Tokens decrypts/extracts all authorization tokens on macOS/OSX》</a></li>
<li><a href="https://www.jianshu.com/p/a3b7140919e4">macOS系统下KeyChain的缺陷</a></li>
</ul>
<h4 id="代码">代码</h4>
<ul>
<li><a href="https://github.com/Noskthing/Scripts/blob/master/getChromeCookies_macOS.py">getChromeCookies</a></li>
<li><a href="https://github.com/Hsn723/MMeTokenDecrypt">MMeTokenDecrypt</a></li>
<li><a href="https://github.com/thanatoskira/OSXChromeDecrypt">OSXChromeDecrypt</a></li>
<li><a href="https://github.com/n8henrie/pycookiecheat">pycookiecheat</a></li>
</ul>
`
    var content = article.split("<!--more-->")[1]
    if (content != null)
        document.getElementById('article').innerHTML = content;
    else
        document.getElementById('article').innerHTML = article

    let navigation = new AutocJs({
        title:'macOS破解Chrome保存的密码————他失败 失败了',
        isGenerateOutlineChapterCode: false
    })
    </script>
</div>
</body>
</html>

