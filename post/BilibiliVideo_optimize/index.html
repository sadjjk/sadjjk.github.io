<html>
<head>
  <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<title>BilibiliVideo-实现篇-优化篇 | 金鱼的今语</title>
<link rel="shortcut icon" href="https://sadjjk.github.io/favicon.ico?v=1668343231821">
<link rel="stylesheet" href="https://sadjjk.github.io/styles/main.css" type='text/css' media='all'>
<link href="https://sadjjk.github.io/media/scripts/autoc.css" rel="stylesheet">

<script src="https://sadjjk.github.io/media/scripts/lib/highlight.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/moment.min.js"></script>
<link href="https://sadjjk.github.io/media/scripts/katex.min.css" rel="stylesheet">



</head>
<body class="home blog ct-body standard">
<div id="overflow-container" class="overflow-container">
  <header id="site-header" class="site-header" role="banner">


    <div class="container">
        <div id="title-info" class="title-info">
            <div id='site-title' class='site-title'>
                <a href="https://sadjjk.github.io">  金鱼的今语 </a>
            </div>
        </div>
        <button id="toggle-navigation" class="toggle-navigation">
            <i class="fa fa-bars"></i>
        </button>
        <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
        <div id="menu-primary" class="menu-container menu-primary" role="navigation">
            <p class="site-description">真话、假话、胡话、全都说</p>
            <div class="menu">
                <ul id="menu-primary-items" class="menu-primary-items">
                     
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/">首页</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/archives">归档</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/tags">标签</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://bili.wjinyu.top" target="_blank">B站视频解析</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://video.wjinyu.top" target="_blank">今日追剧</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="http://music.wjinyu.top" target="_blank">今语云音乐</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="/post/about">关于</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>


</header>


  <div id="main" class="main" role="main">
    <div id="loop-container" class="loop-container">
      <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">
        
          <div class='featured-image lazy lazy-bg-image' data-background="https://i.loli.net/2019/11/10/1XeAfkMLNVRzs2i.png">
          </div>
        

        <div class="entry-meta">
          <span class="date">· 2019-11-10 ·</span>

          
            <span class="category">
                    <span> / </span>
                    <a href="https://sadjjk.github.io/tag/life/">Life</a>
                </span>
          
        </div>
        <div class='entry-header'>
          <h1 class='entry-title'>BilibiliVideo-实现篇-优化篇</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article id="article">

            </article>
          </div>
        </div>
          
            <nav class="navigation pagination" role="navigation">
              <h2 class="screen-reader-text">Posts navigation</h2>
              <div class="nav-links">
                <a class="next page-numbers" style="font-size:20px" href="https://sadjjk.github.io/post/BilibiliVideo_realize/">下一篇->BilibiliVideo-实现篇-基础篇</a>
              </div>
            </nav>
          
      </div>
      <section id="comments" class="comments">
        
      </section>
    </div>
  </div>
  <footer id="site-footer" class="site-footer" role="contentinfo">
    <h1>
        <a href="https://sadjjk.github.io"> 金鱼的今语 </a>
    </h1>
    <p class="site-description" style="font-size:18px">真话、假话、胡话、全都说</p>
    <div id="menu-footer" class="menu-container menu-footer" role="navigation">
        <div class="menu">
            <ul id="menu-footer-items" class="menu-footer-items">
            </ul>
        </div>
    </div>
    <ul class="social-media-icons">
        
            
                <li>
                    <a href="https://github.com/sadjjk" data-animate-hover="pulse" class="github" target="_blank">
                        <i class="fab fa-github" title="github"></i>
                        <span class="screen-reader-text">github</span>
                    </a>
                </li>
            
        
            
        
            
                <li>
                    <a href="https://weibo.com/ " data-animate-hover="pulse" class="weibo" target="_blank">
                        <i class="fab fa-weibo" title="weibo"></i>
                        <span class="screen-reader-text">weibo</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.zhihu.com/" data-animate-hover="pulse" class="zhihu" target="_blank">
                        <i class="fab fa-zhihu" title="zhihu"></i>
                        <span class="screen-reader-text">zhihu</span>
                    </a>
                </li>
            
        
            
        
            
        
            
        
            
        
    </ul>
    <div class="design-credit">
        <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="/atom.xml" target="_blank">RSS</a> | <a href="https://beian.miit.gov.cn" target="_blank">&nbsp;浙ICP备2021037254号-1</a> | <img src="/post-images/gongan.png">浙公网安备 33108202000706号</p>
    </div>
</footer>

<script>
hljs.initHighlightingOnLoad()
</script>
<script src="https://sadjjk.github.io/media/scripts/lib/autoc.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/jquery.min.js"></script>
<script src="https://sadjjk.github.io/media/scripts/lib/production.min.js"></script>

  <script>
    var article = `<p>这一腔热血 只卖与那识货的</p>
<!--more-->
<p>网站：<a href="http://www.wjinyu.top:233/">BilibiliVideo</a></p>
<p><strong>不公开源码 仅提供技术思路 如有疑惑 可留言</strong></p>
<ul>
<li><a href="/post/BilibiliVideo_begin/">BilibiliVideo-缘起篇</a>      ——不讲技术只讲废话</li>
<li><a href="/post/BilibiliVideo_realize/">BilibiliVideo-实现篇-基础篇</a>      ——只有干货没有废话</li>
<li><a href="/post/BilibiliVideo_optimize/">BilibiliVideo-实现篇-优化篇</a>      ——只有干货没有废话</li>
<li><a href="/post/BilibiliVideo_last/">BilibiliVideo-后话篇</a>      ——又说废话没有技术</li>
</ul>
<p>基本篇已经实现了B站视频下载到本地的功能<br>
把这个功能部署在服务上 就可以使用浏览器页面下载<br>
我使用的是Flask  当然无论什么Web框架都是可行的<br>
优化篇说一些部署服务的小细节</p>
<ul>
<li>Flask下载视频流</li>
<li>HTML页面设计</li>
<li>视频解析进度条</li>
<li>添加CSRF Token防御</li>
<li>大会员SESSDATA不过期</li>
</ul>
<h4 id="flask下载视频流">Flask下载视频流</h4>
<p>基本篇是使用<code>urllib.request.urlretrieve</code>下载到本地的<br>
如果是使用服务的话 要用<code>urllib.request.urlopen</code><br>
再封装成Response返回   同时要在Response中添加header<br>
Content-Disposition 视频名<br>
Content-Length  视频大小<br>
这样通过页面下载的视频才有正常的视频名字和视频大小<br>
浏览器下载时才会出现  共XXXMB</p>
<pre><code>@app.route(&quot;/download&quot;,methods=['POST'])
def download():
  -----忽略部分代码-----
  r = urllib.request.urlopen(video_download_url)
  response = Response(
          r,
          content_type=r.headers['content-type'],
      )
  response.headers[&quot;Content-Disposition&quot;] = 'attachment; filename={0}; filename*=utf-8''{0}'.format(quote(video_name) + '.flv')
  response.headers[&quot;Content-Length&quot;] = r.headers['Content-Length']
  
  return response

</code></pre>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2019/11/10/U5R43NVfSF2ZvsK.png" alt="UTOOLS_COMPRESS_1573355993700.png" loading="lazy"></figure>
<h4 id="html页面设计">HTML页面设计</h4>
<p>设计三个基本html页面</p>
<ul>
<li>index 主页 用于输入视频地址</li>
<li>search  解析结果页</li>
<li>search_error  解析结果异常页</li>
</ul>
<p>search_error页可使用Jinja模型语言继承search页<br>
修改要展示的内容即可<br>
若解析异常 则给提出异常提示和热门搜索(其实就是写死的推荐项)<br>
异常可以使用AssertionError断言拦截 比如&quot;链接必须是来自B站&quot;、&quot;链接不能为空&quot;、&quot;无法解析该地址&quot;、&quot;内部异常！可能被233娘吃掉了&quot;等等</p>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2019/11/10/NJQZAvbBGhfynWe.png" alt="UTOOLS_COMPRESS_1573373340096.png" loading="lazy"></figure>
<h4 id="视频解析进度条">视频解析进度条</h4>
<p>当视频地址里视频比较多的时候<br>
解析比较耗时  但页面上没有反应出来<br>
所以最好要有一个前端进度条<br>
这样 对用户就非常友好  非常直观<br>
进度条使用的是NProgress.js插件<br>
非常美观  <a href="http://ricostacruz.com/nprogress/">了解详情点这里</a><br>
使用也很简单  只需要在按钮点击的时候<br>
增加一个start   一个stop  如果是跳转页面 stop可加可不加</p>
<pre><code>$(&quot;.hot-item&quot;).click(function () {
  NProgress.start();
  NProgress.stop();
})
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2019/11/10/3nlKuipDeOdmH69.png" alt="UTOOLS_COMPRESS_1573373940104.png" loading="lazy"></figure>
<p>在页面顶部就有一个进度条 右上还有加载圆 大赞！</p>
<h4 id="添加csrf-token防御">添加CSRF Token防御</h4>
<p>CSRF具体是什么 我不太了解<br>
当初添加这个 主要是想<br>
如果用户模拟出了表单提交的参数<br>
那么直接POST请求就能下载了<br>
(爬虫爬多了的后遗症)<br>
不能这么随便 要加个密什么的<br>
后来查了一些资料 看到了 CSRF Token<br>
Flask里使用也非常简单</p>
<pre><code>from flask_wtf.csrf import CsrfProtect
app.config['SECRET_KEY'] = '自定义加密令牌'
CsrfProtect(app)
</code></pre>
<p>这样表单提交就会自动生成一个<strong>csrf_token</strong><br>
并且验证token的正确性<br>
每次刷新生成的<strong>csrf_token</strong>也都不一样</p>
<figure data-type="image" tabindex="4"><img src="https://i.loli.net/2019/11/10/mM7OoEeDuZ9bJjy.png" alt="UTOOLS_COMPRESS_1573376370149.png" loading="lazy"></figure>
<h4 id="大会员sessdata不过期">大会员SESSDATA不过期</h4>
<p>基础篇提到过SESSDATA是大概有一个月的有效期<br>
既然都发布服务了 总不能每隔一个月去修改SESSDATA吧<br>
所有就需要B站模拟自动登陆 获取Cookies 更新SESSDATA<br>
B站的登陆 是滑块登陆 可以说相当困难<br>
办法也还是有的 Selenium + ChromeDriver<br>
缺点就是会占内存<br>
所幸我们不频繁登陆<br>
只要半个月或一个月登陆一次<br>
获取Cookies 更新SESSDATA 就足够了<br>
自动登陆还有一定失败率 失败就刷新 再次重新滑动<br>
主要难点 在于模拟人的滑动轨迹<br>
不能太快 也不能太慢<br>
实测下来  1次成功到5次才成功不等<br>
写好了模拟登陆的脚本<br>
部署在云服务上  Crontab 定时调用即可<br>
为了了解登陆成功与否的详细<br>
再增加邮箱发送的脚本<br>
这样就能及时了解模拟登陆的情况 及时排查</p>
<figure data-type="image" tabindex="5"><img src="https://i.loli.net/2019/11/10/4KcFfLeq8Q7o9Tm.png" alt="UTOOLS_COMPRESS_1573375534489.png" loading="lazy"></figure>
<p>额外篇 如何实现B站滑块自动登陆 有机会再讲<br>
额外篇 如何实现邮箱发送  有机会再讲</p>
`
    var content = article.split("<!--more-->")[1]
    if (content != null)
        document.getElementById('article').innerHTML = content;
    else
        document.getElementById('article').innerHTML = article

    let navigation = new AutocJs({
        title:'BilibiliVideo-实现篇-优化篇',
        isGenerateOutlineChapterCode: false
    })
    </script>
</div>
</body>
</html>

